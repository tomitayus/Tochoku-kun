# 当直くん - バージョン履歴

## v3.4 (2026-01-29) - TARGET_CAP厳格化+多軸スコアリング+公平性強制

### 新機能
- **多軸スコアリングシステムを実装**
  - 異なる評価軸で最適パターンを選択
  - 3つの評価軸を追加:
    1. **公平性重視**: TARGET_CAP、医師間の割当回数の公平性を最優先
    2. **連続当直回避重視**: gap違反、外病院重複を最優先
    3. **バランス重視**: 大学/外病院バランス、平日/休日バランスを最優先
  - 各軸から最良パターンを1つずつ選択し、合計3パターン出力
  - 同じパターンが複数軸で最良の場合は、総合スコア上位から補填

- **公平性の強制修正機能を追加**
  - `fix_fairness_imbalance()` 関数を実装
  - 最大割当回数と最小割当回数の差を縮める
  - 4回の医師から1回の医師にシフトを移動し、公平性を達成
  - 差が1以下になるまで修正（例: 1回と4回 → 2回と3回）
  - gap制約を守りながら移動先を探索
  - 最適化パイプラインに統合（修正順序の最後に実行）

### 制約の強化
- **TARGET_CAP違反の厳格化**
  - パターン選択時に TARGET_CAP 違反 > 0 のパターンを除外
  - gap違反 > 0 のパターンも除外
  - 未割当 > 0 のパターンも除外
  - ハード制約を満たすパターンのみを候補として選択
  - これにより、TARGET_CAP違反が最終出力に含まれないことを保証

- **公平性制約の強化**
  - active医師間の割当回数の差を最小化
  - n-1回の医師とn+1回の医師が混在する状況を防止
  - 最大200回の試行で公平性を達成
  - gap制約（4日以上の間隔）を守りながらシフトを移動

### 出力の改善
- 各パターンに評価軸ラベルを表示（例: 「公平性重視」「gap回避重視」「バランス重視」）
- TOPパターンのスコア表示に公平性(max-min)を追加
- Excelシートに評価軸ラベルを表示
- 出力説明に多軸評価の詳細を追加

### 技術的詳細
- パターン選択ロジックを2段階に分割:
  1. ハード制約チェック: TARGET_CAP、gap、未割当の違反がないパターンのみ選択
  2. 多軸評価: 各評価軸でソートし、最良パターンを選択
- 各評価軸のソートキー:
  - 公平性: `-cap_violations * 1000`, `-max_minus_min * 100`, `-bg_ht_imbalance * 50`, `raw_score`
  - gap回避: `-gap_violations * 1000`, `-external_dup * 100`, `-hospital_dup * 50`, `raw_score`
  - バランス: `-bg_ht_imbalance * 1000`, `-weekday_weekend_imbalance * 100`, `-bg_over_2 * 100`, `-weekday_over * 100`, `raw_score`
- 公平性修正アルゴリズム:
  1. active医師の割当回数を集計し、最大と最小を計算
  2. 差が2以上の場合、最大の医師から最小の医師にシフトを移動
  3. 移動候補をランダムに選択し、ハード制約とgap制約を満たすか確認
  4. 移動可能な場合、シフトを入れ替え
  5. 差が1以下になるまで繰り返す（最大200回試行）
- 修正パイプライン順序: ハード制約 → TARGET_CAP → 1.2 → BG/HT → gap → 外病院DUP → 大学3+ → 大学平日偏り → **公平性**

---

## v3.0 (2026-01-28) - gap違反修正対応

### 新機能
- **gap違反の自動修正機能を追加**
  - `fix_gap_violations()` 関数を実装
  - 4日未満の間隔での割当を検出し、自動的に修正
  - 違反のある割当を4日以上離れた日に移動
  - 最適化パイプラインに統合

### 制約の強化
- 初期パターン生成時にgap違反3以上の候補のみ選択
- 局所探索でgap違反3未満になるswapを拒否
- 候補が見つからない場合のフォールバック機構を追加

### 技術的詳細
- gap違反とは、同じ医師に4日未満の間隔でシフトが割り当てられること
- 修正アルゴリズムは以下の手順で動作:
  1. 全ての医師の割当日を時系列順にソート
  2. 連続する割当間の間隔が4日未満の箇所を検出
  3. 後の割当を別の日（4日以上離れた日）に移動
  4. ハード制約を満たす移動先が見つかるまで試行

---

## v2.9 (2026-01-28) - gap違反フィルタリング

### 制約の追加
- **gap違反フィルタリング制約を実装**
  - 候補選択時にgap違反0,1,2のパターンを除外
  - gap違反3以上のパターンのみを候補として採用
  - 局所探索で gap違反3未満になるswapを拒否

### バグ修正
- 候補ソートロジックを修正（ループ外でソート処理を実行）

---

## v2.8 (2026-01-24) - BG/HTバランス対応

### 新機能
- **大学系と外病院のバランス制約を追加**
  - 大学系（B～K列）と外病院（L～Y列）の割当回数の差が3未満になるよう制約
  - `fix_bg_ht_imbalance_violations()` 関数で最適化後に差3以上を修正
  - 評価関数に差が3以上の場合のペナルティ追加（重み100）

- **可否コード1.2の医師の大学系最低1回制約を追加**
  - `get_avail_code()` 関数で1.2を認識できるよう修正
  - `fix_code_1_2_violations()` 関数で最適化後に大学系0回を修正
  - 評価関数に1.2の医師が大学系0回の場合のペナルティ追加（重み150）

### バグ修正
- **recompute_stats関数のBG/HT範囲を修正**
  - BG: B～G列 → B～K列
  - HT: H～U列 → L～Y列
  - これにより出力Excelの今月/累計の大学合計・外病院合計が正しく計算される

### 機能改善
- **TARGET_CAP違反の強制修正機能を追加**
  - `fix_target_cap_violations()` 関数で最適化後にTARGET_CAP超過を修正
  - 上位医師（小林、及川等）の割当を下位医師（大河内、猪股等）に移動
  - W_CAPペナルティを50→200に強化

- **余り枠の割当ロジックを修正**
  - 昇順ソート→最後のEXTRA_SLOTS人を選択（下位の医師が優先的に+1回を取得）

- **デバッグ情報の追加**
  - +1回対象の医師名を表示
  - TARGET_CAP設定値を表示
  - 可否コード1.2対象医師を表示

- **デフォルトパターン数を100に変更**（環境変数で上書き可能）

---

## v2.7 (2026-01-24) - ハード制約違反の自動修正

### 新機能
- **ハード制約違反の自動修正機能を実装**
  - `fix_hard_constraint_violations()` 関数を追加
  - 局所探索完了後に全ての違反を自動検出・修正
  - 以下の違反を自動修正:
    - カテ表コード保有医師が外病院（L～Y列）に割当
    - 可否コード0の医師が割当
    - 可否コード2の医師がR～Y列に割当
    - 可否コード3の医師がB～K列に割当
  - 代替医師が見つからない場合は未割当として警告表示
  - 修正後にスコアを再評価して最終結果に反映

---

## v2.6 (2026-01-23) - カテ表コードのバグ修正

### バグ修正
- **get_sched_code関数の重大なバグを修正**
  - "0"と"3"を有効なカテ表コードとして扱わないように変更
  - "0"はデータなし、"3"は可否コードであり、カテ表コードではない
  - これにより、カテ表コード保有医師がその日に"0"や"3"の場合、L～Y列への割当が正しく許可される

---

## v2.5 (2026-01-21) - カテ表コード制約の改善

### 制約の修正
- **カテ表コードと列の制約を修正**
  - sheet3で少なくとも1つのカテ表コード（A,B,C,CC,D,E等）を持つ医師を特定
  - カテ表コード保有医師:
    - その日にコードがある場合のみB～K列可、コードがない日は割当なし
    - その日にコードがある場合はL～Y列禁止
  - カテ表コード非保有医師: B～K列に自由に割り当て可能

### 機能改善
- **出力パターンを1個から3個に変更**（TOP3候補を提示）

---

## v2.4 (2026-01-21) - 列構造の変更対応

### 制約の更新
- **列構造の変更対応（B～Y列）**
  - 可否コード2: B～M列 → B～Q列のみ可
  - 可否コード3: H～U列 → L～Y列のみ可
  - カテ表制約: H～U列禁止 → L～Y列禁止

### 新機能
- **B～H列の2回上限制約を実装**
- **診断シートにB～H列2回超過違反検出を追加**

---

## v2.3 (2026-01-21) - カテ表要件のハード制約化

### 制約の強化
- **B～K列のカテ表要件をハード制約に変更**
  - relax_scheduleで緩和不可
  - B～K列カテ表コード欠如違反の検出機能を追加
  - `can_assign_doc_to_slot()` 関数にB～K列カテ表チェックを追加（局所探索でも適用）

---

## v2.2 (2026-01-21) - 初期ハード制約の実装

### 新機能
- **ハード制約違反の検出機能を実装**
  - 可否コード0の医師の割当違反
  - カテ表コード保有医師の外病院割当違反
  - 可否コード2の医師のR～Y列割当違反
  - 可否コード3の医師のB～Q列割当違反

---

## 主要な制約の一覧

### ハード制約（必須）
1. **可否コード制約**
   - 可否コード0: 割当禁止
   - 可否コード1: 全ての列に割当可能（デフォルト）
   - 可否コード1.2: 大学系（B～K列）優先、最低1回は大学系に割当
   - 可否コード2: B～Q列のみ可
   - 可否コード3: L～Y列のみ可

2. **カテ表コード制約**
   - カテ表コード保有医師: その日にコードがある場合のみB～K列可、L～Y列禁止
   - カテ表コード非保有医師: B～K列に自由に割当可能
   - カテ表コードは A, B, C, CC, D, E 等

3. **同日重複禁止**
   - 同じ医師が同じ日に複数のシフトに割当されない

4. **gap制約**
   - 同じ医師の連続するシフト間隔は4日以上必要
   - gap違反3以上のパターンのみ採用

### ソフト制約（ペナルティ）
1. **割当回数の公平性**
   - TARGET_CAP（目標割当回数）を超える割当にペナルティ（重み200）
   - +1回の枠は下位の医師に優先的に割当

2. **大学系と外病院のバランス**
   - 大学系（B～K列）と外病院（L～Y列）の割当回数の差が3以上の場合にペナルティ（重み100）

3. **病院重複**
   - 同じ医師が同じ病院に複数回割当される場合にペナルティ

4. **未割当枠**
   - 全てのシフト枠を埋めることを優先

---

## 最適化パイプライン

### v3.0のパイプライン
1. **初期パターン生成** (Greedy)
   - NUM_PATTERNS個のパターンを生成
   - gap違反3以上の候補のみを選択
   - TOP_KEEP個の候補を保持

2. **局所探索** (Local Search)
   - REFINE_TOP個の候補を局所探索で改善
   - swapによる最適化
   - gap違反3未満になるswapは拒否

3. **制約違反の自動修正**
   - ハード制約違反の修正 (`fix_hard_constraint_violations`)
   - TARGET_CAP違反の修正 (`fix_target_cap_violations`)
   - 可否コード1.2違反の修正 (`fix_code_1_2_violations`)
   - BG/HTバランス違反の修正 (`fix_bg_ht_imbalance_violations`)
   - **gap違反の修正** (`fix_gap_violations`) ← v3.0で追加

4. **再評価**
   - 修正後のパターンを再評価
   - TOP3候補を出力

---

## パラメータ設定

### デフォルト値
- NUM_PATTERNS: 100（生成パターン数）
- TOP_KEEP: 20（保持候補数）
- REFINE_TOP: 10（局所探索対象数）
- LOCAL_MAX_ITERS: 2000（局所探索の最大イテレーション数）
- LOCAL_PATIENCE: 800（局所探索の打ち切り閾値）
- LOCAL_REFRESH_EVERY: 200（違反医師リストの更新頻度）

### ペナルティ重み
- W_FAIR_TOTAL: 100（公平性）
- W_GAP: 80（gap違反）
- W_HOSP_DUP: 60（病院重複）
- W_UNASSIGNED: 500（未割当）
- W_CAP: 200（TARGET_CAP超過）
- W_CODE_1_2: 150（可否コード1.2違反）
- W_BG_HT_IMBALANCE: 100（BG/HTバランス）

---

## ファイル構成

- `colab_duty_scheduler_v2.1_fixed.py`: メインスケジューラ（v3.0）
- `sheet3_sheet4_data.py`: スケジュールデータと可否コードデータ
- `VERSION_HISTORY.md`: このバージョン履歴ドキュメント

---

## 今後の改善案

1. **gap違反の完全排除**
   - 初期生成時にgap違反0を目指す
   - より効率的な修正アルゴリズムの実装

2. **計算速度の改善**
   - 並列処理の導入
   - キャッシュの活用

3. **ユーザビリティの向上**
   - GUI の追加
   - 設定ファイルによるパラメータ管理

4. **追加の制約対応**
   - 特定の医師の優先度設定
   - 休暇期間の設定機能
