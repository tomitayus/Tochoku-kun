# 当直くん v6.5 制約仕様書

> 本ドキュメントは制約ルールの完全な定義を提供します。
> 実装コード: `colab_duty_scheduler.py` (v6.5.6)

---

## §1 定義

### 1.1 用語定義

| 用語 | 定義 | コード上の表現 |
|------|------|----------------|
| **active医師** | 当月に割り当て可能な医師。sheet2で少なくとも1日は可否コード≠0、または事前割当がある医師 | `active_doctors` |
| **inactive医師** | 当月に割り当て不可の医師。sheet2で全日が可否コード0かつ事前割当なし。**解析処理から除外し、出力データのみに記載** | `inactive_doctors` |
| **BASE_TARGET** | 基本割当回数。`全枠数 ÷ active医師数`（端数切り捨て） | `BASE_TARGET` |
| **EXTRA_SLOTS** | 余り枠数。`全枠数 - (BASE_TARGET × active医師数)` | `EXTRA_SLOTS` |
| **TARGET_CAP** | 医師別の上限回数。通常は`BASE_TARGET`、余り対象医師は`BASE_TARGET + 1` | `TARGET_CAP[doc]` |
| **BG** | 大学系病院（B〜K列）の略称。Big Group の意 | `bg_counts` |
| **HT** | 外病院（L〜Y列）の略称。Hospital (外) の意 | `ht_counts` |
| **カテ当番** | その日にカテ表でアルファベット（A,B,C,CC,D,E等）が入っている状態。v6.5.0以降はSheet1:Z列+Sheet4:カテチーム属性で判定 | `get_sched_code()` |
| **カテ保有医師** | Sheet4のカテチーム属性がSheet1:Zのチームコードと一致する医師 | `SCHEDULE_CODE_HOLDERS` |
| **カテなし医師** | カテチーム属性を持たない医師（自由に配置可能） | `NO_KATE_DOCTORS` |
| **CC** | 大型連休特別シフト。公平性・重複計算から除外される | `is_cc_assignment()` |
| **gap** | 当直間隔。連続する2つの当直日の日数差 | `gap = date2 - date1` |
| **属性** | Sheet4の「属性」列。1=緩和可、2=緩和不可。SEMI-001の緩和判定に使用 | `doctor_attribute` |

### 1.2 列定義（Column Classification）

| 列範囲 | インデックス | 分類 | 説明 | カテ制約 |
|--------|-------------|------|------|---------|
| **B列** | 1 | 大学平日① | 平日の大学系当直（昼） | 緩和可 |
| **C-H列** | 2-7 | 大学休日 | 土日祝の大学系当直 | **カテ当番必須（ABS-013）** |
| **I列** | 8 | 大学平日② | 平日の大学系当直（昼） | 緩和可 |
| **J-K列** | 9-10 | 大学平日③ | 平日の大学系当直 | 緩和可 |
| **L-Y列** | 11-24 | 外病院 | 外部病院への派遣当直 | カテ当番日禁止 |

**時間帯分類（C-H列内）:**
- **昼（Day）**: C列、E列、F列
- **夜（Night）**: D列、G列

**グループ定義:**
```
大学系（B-K列）= B + C-H + I-K = インデックス 1-10
  ├─ 平日大学系 = B列 + I-K列（カテ制約緩和可）
  └─ 休日大学系 = C-H列（カテ当番必須）
外病院（L-Y列）= インデックス 11-24
```

**設計背景（J-K列が平日扱いの理由）:**
> J-K列は運用上、平日の補助枠として使用されている。休日（C-H列）はカテ当番との連携が重要だが、J-K列は平日業務の延長であるためカテ制約を緩和している。将来的にJ-K列の運用が変更される場合は、本定義の見直しが必要。

### 1.3 可否コード定義（Sheet2）

| コード | 意味 | 配置可能列 | 備考 |
|--------|------|-----------|------|
| **0** | 不可 | なし | その日は割り当て禁止（絶対禁忌） |
| **1** | 可 | B〜Y全て | 通常の配置対象 |
| **1.2** | 大学優先 | B〜Y全て | 大学系（B-K）を最低1回必須（準ハード） |
| **2** | 大学専用 | B〜Q列のみ | 外病院不可、EXTRA枠対象外 |
| **3** | 外病院専用 | L〜Y列のみ | 大学系不可、比率バランス除外 |

**特記事項:**
- **全日0の医師**: `inactive_doctors`として解析処理から完全除外。出力Excelには0回として記載
- **コード2医師**: v6.0.5以降EXTRA枠対象に含む。ただしTARGET_CAPは厳守

### 1.4 パラメータ定義

#### TARGET_CAP算出方法
```python
BASE_TARGET = total_slots // len(active_doctors)
EXTRA_SLOTS = total_slots - BASE_TARGET * len(active_doctors)

# 余り枠は属性1の医師を優先、不足時はSheet2末尾からフォールバック
# v6.0.5: CODE_2医師もEXTRA対象に含む
attr1_doctors = [d for d in active_sorted if doctor_attribute[d] == "1"]
EXTRA_ALLOWED = attr1_doctors[-EXTRA_SLOTS:]  # 属性1優先

TARGET_CAP[doc] = BASE_TARGET                    # 通常医師
TARGET_CAP[doc] = BASE_TARGET + 1                # EXTRA対象医師
TARGET_CAP[doc] = max(TARGET_CAP[doc], 事前割当数)  # 事前割当優先

# v6.1.0: gap>=3制約を満たせる物理的上限でCAPを制限
max_gap3 = compute_max_gap3_assignments(doc)
TARGET_CAP[doc] = min(TARGET_CAP[doc], max_gap3)
```

#### gap（間隔）の計算方法
```
間隔 = 次回当直日 - 前回当直日 の日数差

例:
  1/1 → 1/2 : gap = 1日 → NG（3日未満）
  1/1 → 1/3 : gap = 2日 → NG（3日未満）
  1/1 → 1/4 : gap = 3日 → OK（3日以上）

判定: gap < 3 → 違反
```

### 1.5 カテ表コード定義

v6.5.0以降、カテ当番の判定は以下の2段階で行われる:

1. **Sheet1:Z列「カテ当番」** - 日付ごとのチームコード（A, B, C, D, E等）
2. **Sheet4:カテチーム属性** - 医師ごとのチーム所属

| コード | 意味 | 配置への影響 |
|--------|------|-------------|
| **A,B,C,D,E等** | カテ当番（アルファベット） | その日L-Y禁止、C-H優先配置 |
| **CC** | 大型連休特別シフト | 公平性・重複計算から除外 |
| **1** | 平日大学緩和フラグ / 属性1 | B/I-K列でカテなしでも配置可 |
| **3** | 比率除外フラグ | BG/HT比率計算から除外 |
| **0 / 空白** | カテなし | C-H自由配置可、カテ制約なし |

---

## §2 制約一覧

> **制約ID体系**: `ABS`=絶対禁忌, `HARD`=ハード, `SEMI`=準ハード, `SOFT`=ソフト

### 2.1 絶対禁忌（違反=即却下・配置不可）

| ID | 制約名 | 条件 | 実装 |
|----|--------|------|------|
| ABS-001 | 可否コード0禁止 | `get_avail_code(date, doc) == 0` | `collect_candidates`で除外 |
| ABS-002 | コード2の列制約 | コード2医師がR〜Y列に配置 | `collect_candidates`で除外 |
| ABS-003 | コード3の列制約 | コード3医師がB〜K列に配置 | `collect_candidates`で除外 |
| ABS-004 | カテ当番日の外病院禁止 | カテ保有医師がカテ当番日にL〜Y列配置 | `collect_candidates`で除外 |
| ABS-005 | 水曜日L〜Y禁止医師 | 指定医師が水曜日にL〜Y列配置 | `WED_FORBIDDEN_DOCTORS`で除外 |
| ABS-006 | 同日重複禁止 | 同一医師が同一日に2枠以上 | ロジックで排除 |
| ABS-007 | gap>=3日必須 | 連続当直の間隔が3日未満 | `collect_candidates`で除外（v6.0.0: ABS格上げ） |
| ABS-008 | 同一病院重複禁止 | 初期生成時は全列、fix関数では外病院のみ | `collect_candidates` / `is_valid_full_assignment` |
| ABS-010 | TARGET_CAP厳守 | 割当回数がTARGET_CAPを超過 | `collect_candidates`で除外（v6.0.0: ABS格上げ） |
| ABS-011 | 大学系2回まで | B-K列の合計が2回を超過 | `collect_candidates`で除外 |
| ABS-012 | 大学系7日間隔必須 | 大学系割当の間隔が7日未満（v6.5.0） | `collect_candidates`で除外 |
| ABS-013 | C-H列カテ当番必須 | 休日大学系にカテ当番日以外で配置（v6.5.3、旧SEMI-002格上げ） | `collect_candidates`で除外 |
| ABS-015 | 属性2のB列カテ表必須 | 属性2医師がカテ表なしでB列に配置（v6.5.6） | `collect_candidates`で除外 |

**v5.2からの変更点:**
- ABS-007, ABS-008, ABS-010: v6.0.0でSOFT/HARDからABS（絶対禁忌）に格上げ
- ABS-011, ABS-012: v6.0.0/v6.5.0で追加
- ABS-013: v6.5.3でSEMI-002から格上げ
- ABS-015: v6.5.6で追加

### 2.2 ハード制約（パターン選択時の判定基準）

v6.0.0以降、ハード制約の多くはABS（絶対禁忌）に格上げされた。
パターン選択時に以下の違反が多いパターンは低順位となる:

| ID | 制約名 | 違反判定 | 処理 |
|----|--------|----------|------|
| HARD-001 | B/I列1回まで | `assigned_bi[doc] >= 1` | グループA制約 |
| HARD-002 | C-H/J-K列1回まで | `assigned_chjk[doc] >= 1` | グループB制約 |
| HARD-003 | 未割当枠 | 空き枠が残存 | `fix_unassigned_slots`で修正 |

### 2.3 準ハード制約（条件付き緩和可）

選択肢がない場合に限り緩和される:

| ID | 制約名 | 緩和条件 | 備考 |
|----|--------|----------|------|
| SEMI-001 | B列カテ表コード必須 | 属性1の医師は週1回まで許容。属性2は緩和不可（ABS該当） | v6.5.6: 属性で緩和可否を判定 |

**v5.2からの変更点:**
- SEMI-002: v6.5.3でABS-013に格上げ
- SEMI-003（gap制約）: v6.0.0でABS-007に格上げ（削除）
- SEMI-004（大学最低1回）: `fix_university_minimum_requirement`で対応（削除）

**段階的制約緩和フロー（v6.3.0）:**
```
1. 全制約適用でチェック
   ↓ 候補なし
2. relax_semi=True で再試行（SEMI-001緩和）
   ↓ 候補なし
3. relax_hard=True で再試行（HARD制約緩和）
   ↓ 候補なし
4. relax_abs=True で再試行（ABS-007/008/010/011/012緩和）
   ※ ABS-001〜006, ABS-013は緩和不可
```

### 2.4 ソフト制約（ペナルティ加算）

#### 2.4.1 ほぼ禁忌（W>=300: 事実上のハード制約）

| ID | 制約名 | ペナルティ重み | 説明 |
|----|--------|---------------|------|
| SOFT-001 | 外病院0回 | 300 | active医師は外病院最低1回必須 |
| SOFT-002 | 大学3回以上 | 300 | `bg_count >= 3`（CC除く） |
| SOFT-003 | CODE_2医師CAP超過 | 300 | CODE_2医師のTARGET_CAP超過 |
| SOFT-004 | 全体平日/休日偏り | 300 | 平日/休日差が2以上 |
| SOFT-005 | 休日0回 | 300 | active医師で休日割当0回 |
| SOFT-006 | 大学系週1違反 | 300 | ABS-012の残留違反 |

#### 2.4.2 中程度の回避（W=50-200）

| ID | 制約名 | ペナルティ重み | 説明 |
|----|--------|---------------|------|
| SOFT-007 | 未割当 | W_UNASSIGNED=500 | 未割当スロット（最優先修正対象） |
| SOFT-008 | CODE_1.2大学0回 | 150 | 大学最低1回未達 |
| SOFT-009 | C-Hカテ当番違反 | 120 | C-H列にカテ当番日以外で割当 |
| SOFT-010 | BG/HT差3以上 | 100 | 大学と外病院の不均衡 |
| SOFT-011 | 大学平日2回以上 | 80 | 平日偏り回避 |
| SOFT-012 | 大学2回平日/休日バランス | 50 | 大学2回の場合、平日1+休日1が理想 |

#### 2.4.3 軽微な非推奨（W=1-50）

| ID | 制約名 | ペナルティ重み | 説明 |
|----|--------|---------------|------|
| SOFT-013 | 公平性 | W_FAIR_TOTAL=30 | `max(割当数) - min(割当数)` の差。差>=2で2倍ペナルティ |

### 重み定数一覧（v6.0.0以降）

```python
# v6.0.0: GAP/CAP/外病院重複はABS（絶対禁忌）に格上げされペナルティ重み0
W_FAIR_TOTAL = 30          # SOFT-013: 公平性（max-min最小化）
W_HOSP_DUP = 0             # 大学重複（許容）
W_GAP = 0                  # ABS-007で対応
W_EXTERNAL_HOSP_DUP = 0    # ABS-008で対応
W_UNASSIGNED = 500         # SOFT-007: 未割当ペナルティ
W_CAP = 0                  # ABS-010で対応
W_BG_SPREAD = 0            # 削除（簡略化）
W_HT_SPREAD = 0            # 削除（簡略化）
W_WD_SPREAD = 0            # 削除（簡略化）
W_WE_SPREAD = 0            # 削除（簡略化）
W_BK_LY_BALANCE = 0        # 削除（簡略化）
```

---

## §3 配置ロジック

> 注意: 本セクションは制約定義ではなく、配置アルゴリズムの仕様です。

### 3.1 配置優先順序

```
1. 大学休日（C-H列）← カテ当番制約があるため先に配置
2. 大学平日（B列、I-K列）
3. 外病院（L-Y列）
```

### 3.2 休日大学系（C-H列）の配置ルール

**配置可能条件（OR条件）:**
1. その日にカテ当番がある（Sheet1:Zのチームコードが医師のチーム属性と一致）
2. カテなし医師（カテチーム属性を持たない）

> **関連制約**: ABS-013（v6.5.3でSEMI-002から格上げ。緩和不可）

### 3.3 平日大学系（B列 + I-K列）の配置ルール

**配置可能条件（OR条件）:**
1. カテなし医師
2. その日にカテ当番がある
3. 属性1の医師 / sheet3で「1」を持つ医師（SEMI-001緩和対象）

> **関連制約**: SEMI-001
> **属性による緩和可否（v6.5.6）:**
> - 属性1: 緩和可（週1回までカテ表なしでB列配置を許容）
> - 属性2: 緩和不可（ABS-015として扱い、カテ表必須）

### 3.4 修正パイプライン（実行順序）

```
#1  fix_hard_constraint_violations()        # 絶対禁忌の修正
#2  fix_code_2_extra_violations()           # CODE_2のTARGET_CAP超過
#3  fix_target_cap_violations()             # TARGET_CAP超過
#4  fix_university_minimum_requirement()    # 大学最低1回必須
#5  fix_ch_kate_violations()                # C-Hカテ当番違反
#6  fix_bg_ht_imbalance_violations()        # BG/HT不均衡
#7  fix_gap_violations()                    # gap違反
#8  fix_external_hospital_dup_violations()  # 外病院重複
#9  fix_university_over_2_violations()      # 大学3回以上
#10 fix_university_weekday_balance()        # 大学平日偏り
#11 fix_fairness_imbalance()                # 公平性
#12 fix_unassigned_slots()                  # 未割当枠
```

**順序設計の根拠:**

| フェーズ | 修正関数 | 依存関係・理由 |
|---------|----------|---------------|
| **Phase 1: 絶対禁忌** | #1 | 最優先。他の全修正の前提条件 |
| **Phase 2: CAP系** | #2-#3 | CAPが正しくないと他の均衡計算が狂う |
| **Phase 3: 必須配置** | #4-#5 | 大学最低1回・カテ制約を満たす |
| **Phase 4: バランス** | #6-#10 | BG/HT, gap, 重複を順次調整 |
| **Phase 5: 微調整** | #11-#12 | 公平性調整と残枠埋め（最後） |

**収束ループ（v6.0.3）:**
各fix関数は `safe_fix` ラッパーで実行され、収束するまで最大3回ループする。
fix関数がスコアを悪化させた場合は変更をrevertし、元のパターンを保持する。

---

## §4 inactive医師の扱い

### 定義
```python
def is_always_unavailable(doc):
    # 事前割当があれば対象外
    if preassigned_count.get(doc, 0) > 0:
        return False
    # 全日コード0ならinactive
    return all(get_avail_code(d, doc) == 0 for d in all_shift_dates)

inactive_doctors = [d for d in doctor_names if is_always_unavailable(d)]
```

### 処理方針

| フェーズ | inactive医師の扱い |
|----------|-------------------|
| **解析処理** | 完全除外（候補に含めない） |
| **TARGET_CAP計算** | 除外（active医師のみで計算） |
| **パターン生成** | 除外 |
| **最適化** | 除外 |
| **出力Excel** | 0回として記載（氏名は表示） |

---

## §5 クイックリファレンス

### 制約ID一覧

| カテゴリ | ID範囲 | 説明 |
|---------|--------|------|
| **ABS** | ABS-001〜015 | 絶対禁忌（配置不可） |
| **HARD** | HARD-001〜003 | ハード制約（パターン選択時の判定基準） |
| **SEMI** | SEMI-001 | 準ハード制約（緩和可） |
| **SOFT** | SOFT-001〜013 | ソフト制約（ペナルティ） |

### 列インデックス対応表

| 列名 | Index | 分類 | カテ制約 | 関連制約ID |
|------|-------|------|---------|-----------|
| B | 1 | 平日大学系 | 緩和可 | SEMI-001, ABS-015(属性2) |
| C-H | 2-7 | 休日大学系 | カテ当番必須 | ABS-013 |
| I-K | 8-10 | 平日大学系 | 緩和可 | SEMI-001 |
| L-Y | 11-24 | 外病院 | カテ当番日禁止 | ABS-004 |

### 医師分類早見表

| 分類 | 判定条件 | 主な制約ID |
|------|----------|-----------|
| active | sheet2で1日でも≠0 | 全制約対象 |
| inactive | sheet2全日=0 | 解析除外、出力のみ |
| CODE_2 | sheet2にコード2あり | ABS-002 |
| CODE_3 | sheet2にコード3あり | ABS-003 |
| CODE_1.2 | sheet2にコード1.2あり | 大学最低1回必須 |
| カテ保有 | Sheet4のカテチーム属性がSheet1:Zと一致 | ABS-004, ABS-013 |
| カテなし | カテチーム属性なし | - |
| 属性1 | Sheet4属性=1 | SEMI-001緩和可 |
| 属性2 | Sheet4属性=2 | ABS-015（B列カテ表必須） |

---

## 更新履歴

| 日付 | バージョン | 変更内容 |
|------|-----------|---------|
| 2026-02-12 | v6.5 | v6.x系の変更を反映: ABS-007/008/010のABS格上げ、ABS-011〜015追加、SEMI-002〜004削除（格上げ/統合）、重み定数をv6.0.0仕様に更新（GAP/CAP/外病院重複=0）、段階的制約緩和（relax_abs）、修正パイプライン更新、属性による緩和可否、safe_fixラッパー |
| 2026-01-31 | v5.2 | 制約ID体系（ABS/HARD/SEMI/SOFT-XXX）を導入。緩和フラグ命名の歴史的経緯を注記。§1.2にJ-K列の設計背景を追記。§4.3の表記を「平日大学系」に統一。§6に制約ID一覧を追加 |
| 2026-01-31 | v5.1 | ハード/ソフト境界を明確化（§2.2, §2.4再構成）。§1.5にSheet3コード定義追加。水曜日L〜Y禁止制約を§2.1に追加。CODE_1.2と準ハード#4の関係性を整理。修正パイプラインの順序根拠を追記 |
| 2026-01-30 | v5.0 | 制約仕様書を新規作成。用語定義、列分類、ペナルティスケールを明確化 |
